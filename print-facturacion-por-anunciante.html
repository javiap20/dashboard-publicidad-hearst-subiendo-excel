
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>PRINT - Facturaci√≥n por Anunciante</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --card:#111827;
  --text:#e5e7eb;
  --base:#38bdf8;      /* azul */
  --comp:#f59e0b;      /* amarillo */
  --neg:#f87171;       /* rojo */
  --diffColor:#6ee7b7; /* verde claro */
  --ok-green:#34d399;  
  --totalBg:#1e40af;
  --fucsia: #db2777;   /* Color fucsia para PRINT */

  --revistaBg:#fef3c7; 
  --productoBg:#dbeafe; 
  --sectorBg:#fbcfe8;
  --comercialBg:#d1fae5; 
  --areaBg:#fcd5ce; 
  --anuncianteBg:#e9d5ff;

  --title-mes:var(--comp);
  --title-revista:var(--comp);
  --title-producto:var(--comp);
  --title-comercial:var(--comp);

  --bullet-size: 1.1rem;
  --bullet-indent: 22px;
  --summary-bg:#111827;
  --summary-border:#4b5563;
  --base-color: #f59e0b;
}

body {
  margin: 0;
  font-family: 'Inter', Arial, sans-serif; /* Usa la misma en ambos */
  background: linear-gradient(180deg,#020617,#0f172a);
  color: var(--text);
  overflow-y: scroll; /* Esto evita que el men√∫ se mueva a la izquierda/derecha */
}

.nav-menu {
  background: #111827;
  padding: 15px;
  text-align: center;
  border-bottom: 1px solid #374151;
  position: sticky;
  top: 0;
  z-index: 1000;
  height: 55px; /* Altura fija para bloquear cualquier movimiento */
  display: flex;
  align-items: center;
  justify-content: center;
}

.nav-menu a {
  color: #fff;
  margin: 0 10px;
  text-decoration: none;
  font-size: .9em;
  opacity: 0.8; /* Misma opacidad en ambos */
}
.nav-menu a:hover{ opacity:1; color:var(--base); }
.nav-menu .active{ font-weight:bold; border-bottom:2px solid var(--base); opacity:1; padding-bottom: 5px; }

h1{ text-align:center; margin:20px 0; font-size: 1.5em; }

.container{ max-width:1500px; margin:auto; padding:20px; }

.card{
  background:rgba(17,24,39,.9);
  border-radius:14px;
  padding:18px;
  margin-bottom:20px;
  border: 1px solid #1f2937;
}

.upload-label { 
    display: block; 
    font-weight: bold; 
    margin-bottom: 12px; 
    font-size: 0.95em;
}
.file-input-wrapper {
    background: #1f2937;
    border: 1px solid #374151;
    border-radius: 8px;
    padding: 10px;
    display: flex;
    align-items: center;
}
#fileInput {
    background: transparent;
    border: none;
    color: var(--text);
    width: 100%;
    margin-bottom: 0;
    padding: 0;
}
#loadStatus {
    margin-top: 12px;
    font-weight: 600;
    font-size: 0.85em;
    display: flex;
    align-items: center;
    gap: 5px;
}

.filters select,input[type=file]{
  background:#1f2933;
  color:var(--text);
  border:1px solid #1f2937;
  padding:8px 10px;
  border-radius:8px;
  margin-right:14px;
}
.filters label{ font-weight:600; margin-right:6px; display:block; margin-top:10px; }

.filtersRow{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
  align-items:flex-start;
}
.filtersRow div select{ width:220px; font-weight:600; }

#fRevista{ background:var(--revistaBg); color:#111; }
#fProduct{ background:var(--productoBg); color:#111; }
#fSector{ background:var(--sectorBg); color:#111; }
#fComercial{ background:var(--comercialBg); color:#111; }
#fArea{ background:var(--areaBg); color:#111; }
#fAnunciante{ background:var(--anuncianteBg); color:#111; }

.checkboxGroup{ display:flex; flex-wrap:wrap; gap:10px; margin-top:5px; }
.checkboxGroup label{ font-weight:400; cursor: pointer; }

.totalBlock{ background:var(--totalBg); padding:15px; border-radius:12px; margin-top:10px; }
.totalValues{ display:flex; justify-content:space-around; font-size:18px; }
.totalValues div{text-align:center;}
.totalValues .value{ font-size:22px; font-weight:700; }
#diffPercent.negative{ color:var(--neg); }

.statsBlock{ display:flex; justify-content:center; border-radius:12px; margin:20px 0; gap:10px; flex-wrap:wrap; }
.subBlock{ border-radius:12px; padding:20px; display:flex; align-items:center; justify-content:center; }
.statsBase{ flex:0 0 450px; background:var(--comp); color:#111; }
.statsDiff{ flex:0 0 300px; background:var(--diffColor); color:#111; }
.statsComp{ flex:0 0 450px; background:var(--base); color:#111; }

.statsValues{ display:flex; justify-content:center; font-size:16px; gap:18px; flex-wrap:wrap; }
.statsValues div{text-align:center;}
.statsValues .value{ font-size:18px; font-weight:700; display:block; margin-top:5px; }
.statsDiff .value.negative{ color:var(--neg); }

.summaryCard{
  border:1px dashed var(--summary-border);
  background:var(--summary-bg);
  border-radius:12px;
  padding:18px;
  color:#cbd5e1;
}
.summaryCard h2{ margin:0 0 14px 0; font-size:1.15em; color:#fff; }

.summaryGrid{
  display:grid;
  grid-template-columns:repeat(2,minmax(280px,1fr));
  gap:18px;
}

.summaryHeader{
  font-weight:800;
  color:#fff;
  border:1px solid #1f2937;
  border-radius:10px;
  padding:10px 12px;
  background:rgba(17,24,39,0.6);
}

.summarySection{
  background:rgba(2,6,23,0.35);
  border:1px solid rgba(75,85,99,0.5);
  border-radius:12px;
  padding:12px;
  height:100%;
}

.summaryTitle{ font-weight:800; margin-bottom:10px; }
.summaryTitle.mes{ color:var(--title-mes); }
.summaryTitle.revista{ color:var(--title-revista); }
.summaryTitle.producto{ color:var(--title-producto); }
.summaryTitle.comercial{ color:var(--title-comercial); }

.itemList{ list-style:none; padding:0; margin:0; }
.itemList li{
  position:relative;
  padding-left: var(--bullet-indent);
  margin:8px 0;
  color:#e5e7eb;
}
.itemList li::before{
  content:"‚úî";
  position:absolute;
  left:0;
  color: inherit;
}
.itemList.mes li::before{ color:var(--title-mes); }
.itemList.revista li::before{ color:var(--title-revista); }
.itemList.producto li::before{ color:var(--title-producto); }
.itemList.comercial li::before{ color:var(--title-comercial); }

.amount{ font-weight:bold; margin-left:5px; }
.pct{ margin-left:5px; font-size:0.9em; }
.pct.neg{ color:var(--neg); }
.pct.pos{ color:var(--ok-green); }
.sep { color: #4b5563; }
</style>
</head>

<body>

<nav class="nav-menu">
    <span style="color: var(--base-color); font-weight: bold; margin-right: 10px; opacity: 1;">DIGITAL:</span>
    <a href="digital-datos-graficos.html">Datos</a>
    <a href="digital-facturacion-desglosada.html">Desglose</a>
    <a href="digital-facturacion-por-anunciante.html">Anunciantes</a>
    <a href="digital-facturacion-por-anunciante-y-marca.html">Marcas</a>
    <a href="digital-totales-familas-productos.html">Productos</a>

    <span style="color: var(--fucsia); font-weight: bold; margin-left: 20px; margin-right: 10px; border-left: 1px solid #4b5563; padding-left: 20px; opacity: 1;">PRINT:</span>
    <a href="print-datos-graficos.html">Datos</a>
    <a href="print-facturacion-desglosada.html">Desglose</a>
    <a href="print-facturacion-por-anunciante.html" class="active">Anunciantes</a>
    <a href="print-facturacion-por-anunciante-y-marca.html">Marcas</a>
    
    <a href="index.html" style="margin-left: 20px; border-left: 1px solid #4b5563; padding-left: 20px;">üè† Home</a>
</nav>

<h1>PRINT - Facturaci√≥n por Anunciante</h1>

<div class="container">
  <div class="card">
    <label class="upload-label">Cargar datos (Excel):</label>
    <div class="file-input-wrapper">
        <input type="file" id="fileInput" accept=".json,.xlsx">
    </div>
    <div id="loadStatus">Esperando archivo...</div>
  </div>
  <div id="advBlock" class="card filters" style="display:none">
    <div class="filtersRow">
      <div><label>Anunciante (Por Facturaci√≥n Total)</label><select id="fAnunciante"></select></div>
    </div>
  </div>

  <div id="revistaBlock" class="card filters" style="display:none">
    <div class="filtersRow">
      <div><label>Revista</label><select id="fRevista"></select></div>
      <div><label>Producto</label><select id="fProduct"></select></div>
      <div><label>Sector</label><select id="fSector"></select></div>
      <div><label>Comercial</label><select id="fComercial"></select></div>
      <div><label>√Årea</label><select id="fArea"></select></div>
    </div>
  </div>

  <div id="filters" class="card filters" style="display:none">
    <div class="filtersRow">
      <div>
        <label style="color:var(--comp);font-weight:800;">A√±o base</label>
        <select id="fYear"></select>
        <div class="checkboxGroup" id="monthsBase"></div>
      </div>
      <div>
        <label style="color:var(--base);font-weight:800;">A√±o comparaci√≥n</label>
        <select id="fYear2"></select>
        <div class="checkboxGroup" id="monthsComp"></div>
      </div>
    </div>
  </div>

  <div id="totalBlock" class="card filters" style="display:none">
    <div class="totalBlock">
      <div class="totalValues">
        <div><div>A√±o base</div><div id="totalYear1" class="value">0‚Ç¨</div></div>
        <div><div>A√±o comparaci√≥n</div><div id="totalYear2" class="value">-</div></div>
        <div><div>% diferencia</div><div id="diffPercent" class="value">-</div></div>
      </div>
    </div>
  </div>

  <div id="statsBlock" class="card filters" style="display:none">
    <div class="statsBlock">
      <div class="subBlock statsBase">
        <div class="statsValues">
          <div><div>Fact. A√±o Base</div><div id="totalStatsBase" class="value">0‚Ç¨</div></div>
          <div><div>N¬∫ l√≠neas</div><div id="linesStatsBase" class="value">0</div></div>
          <div><div>Presupuesto medio</div><div id="avgStatsBase" class="value">0‚Ç¨</div></div>
        </div>
      </div>
      <div class="subBlock statsDiff">
        <div class="statsValues">
          <div><div>% Crecimiento Presupuesto Medio</div><div id="diffAvgStats" class="value">0%</div></div>
        </div>
      </div>
      <div class="subBlock statsComp">
        <div class="statsValues">
          <div><div>Fact. A√±o Comparaci√≥n</div><div id="totalStatsComp" class="value">-</div></div>
          <div><div>N¬∫ l√≠neas</div><div id="linesStatsComp" class="value">0</div></div>
          <div><div>Presupuesto medio</div><div id="avgStatsComp" class="value">-</div></div>
        </div>
      </div>
    </div>
  </div>

  <div id="advSummaryCard" class="summaryCard" style="display:none">
    <h2>Resumen por anunciante</h2>
    <div class="summaryGrid">
      <div class="summaryHeader">A√±o base: <span id="summaryYearBase">‚Äî</span></div>
      <div class="summaryHeader">A√±o comparaci√≥n: <span id="summaryYearComp">‚Äî</span></div>

      <div class="summarySection"><div class="summaryTitle mes">Mes</div><ul id="advMonthsBase" class="itemList mes"></ul></div>
      <div class="summarySection"><div class="summaryTitle mes">Mes</div><ul id="advMonthsComp" class="itemList mes"></ul></div>
      <div class="summarySection"><div class="summaryTitle revista">Revista</div><ul id="advRevistasBase" class="itemList revista"></ul></div>
      <div class="summarySection"><div class="summaryTitle revista">Revista</div><ul id="advRevistasComp" class="itemList revista"></ul></div>
      <div class="summarySection"><div class="summaryTitle producto">Producto</div><ul id="advProductsBase" class="itemList producto"></ul></div>
      <div class="summarySection"><div class="summaryTitle producto">Producto</div><ul id="advProductsComp" class="itemList producto"></ul></div>
      <div class="summarySection"><div class="summaryTitle comercial">Comercial</div><ul id="advSalesBase" class="itemList comercial"></ul></div>
      <div class="summarySection"><div class="summaryTitle comercial">Comercial</div><ul id="advSalesComp" class="itemList comercial"></ul></div>
    </div>
  </div>
</div>

<!-- ======= BLOQUE A√ëADIDO: Auto-carga del Excel (PRODUCCION PRINT.xlsx) ======= -->
<script>
// Opci√≥n A: Excel en la misma carpeta que este HTML
const excelUrl = "PRODUCCION%20PRINT.xlsx";

// Opci√≥n B: Excel en GitHub Raw (descomenta y pega tu URL cruda si lo prefieres)
// const excelUrl = "https://raw.githubusercontent.com/USUARIO/REPO/BRANCH/ruta/PRODUCCION%20PRINT.xlsx";

window.addEventListener("DOMContentLoaded", () => {
  const statusEl = document.getElementById("loadStatus");
  if (statusEl) statusEl.innerText = "Cargando archivo PRODUCCION PRINT.xlsx‚Ä¶";

  fetch(excelUrl)
    .then(resp => {
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return resp.arrayBuffer();
    })
    .then(buf => {
      const wb = XLSX.read(buf, { type: "array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval: "" });
      // Reutilizamos tu flujo original:
      init(json);
      if (statusEl) {
        statusEl.innerText = "‚úÖ Archivo cargado autom√°ticamente";
        statusEl.style.color = "var(--ok-green)";
      }
      // (Opcional) Desactivar el input manual si quieres:
      // const fi = document.getElementById("fileInput"); if (fi) fi.disabled = true;
    })
    .catch(err => {
      console.error("Auto-carga fallida:", err);
      if (statusEl) {
        statusEl.innerText = "‚ö†Ô∏è No se pudo cargar autom√°ticamente. Selecciona el Excel manualmente.";
        statusEl.style.color = "var(--neg)";
      }
    });
});
</script>
<!-- ======= FIN BLOQUE A√ëADIDO ======= -->

<script>
const MONTHS = ["01 Enero","02 Febrero","03 Marzo","04 Abril","05 Mayo","06 Junio","07 Julio","08 Agosto","09 Septiembre","10 Octubre","11 Noviembre","12 Diciembre"];
const MONTH_NAMES = MONTHS.map(m => m.slice(3));
let rawData = [];

function normalizeText(s){
  if(s==null) return "";
  return String(s).trim().toUpperCase();
}

function cleanSector(s){
  if(!s) return "SIN SECTOR";
  let txt = String(s).trim().toUpperCase();
  if(txt.includes("*")){
    return txt.split("*").pop().trim();
  }
  return txt;
}

function cleanRaw(s){
  if(s==null) return "";
  return String(s).replace(/\u00A0/g," ").trim().replace(/\s+/g," ");
}
function toTitleCase(s){
  return cleanRaw(s).toLowerCase().replace(/\b\p{L}+/gu, w => w.charAt(0).toUpperCase()+w.slice(1));
}
function normalizeMonth(m){
  if(!m) return "";
  const s = String(m).trim();
  const nn = s.substring(0,2);
  return MONTHS.find(x=>x.startsWith(nn)) || "";
}
function num(v){
  if(v==null) return 0;
  if(typeof v === 'number') return v;
  const s = String(v).replace(/\u00A0/g," ").replace(/‚Ç¨/g,"").replace(/\s/g,"").replace(/\./g,"").replace(/,/g,".");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}
function isURL(txt){
  const t = (txt||"").trim();
  return /^https?:\/\/|^www\./i.test(t) || /[a-z0-9]\.[a-z]{2,}$/i.test(t);
}

const currencyFormatter=new Intl.NumberFormat('es-ES',{useGrouping:true,minimumFractionDigits:0,maximumFractionDigits:0});
function formatCurrency(n){ const v=Math.round(Number(n)||0); return (Number.isFinite(v)?currencyFormatter.format(v):'0')+'‚Ç¨'; }
const integerFormatter=new Intl.NumberFormat('es-ES',{useGrouping:true});
function formatInteger(n){ return integerFormatter.format(n||0); }

fileInput.onchange = e => {
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ev => {
    try {
      const ext = f.name.split(".").pop().toLowerCase();
      if(ext==="json") {
        init(JSON.parse(ev.target.result));
      } else {
        const data = new Uint8Array(ev.target.result);
        const wb = XLSX.read(data, {type:"array"});
        const ws = wb.Sheets[wb.SheetNames[0]];
        init(XLSX.utils.sheet_to_json(ws, { defval: "" }));
      }
      document.getElementById("loadStatus").innerHTML = "‚úÖ Archivo cargado";
      document.getElementById("loadStatus").style.color = "var(--ok-green)";
    } catch (err) {
      document.getElementById("loadStatus").innerText = "‚ùå Error al leer el archivo";
      document.getElementById("loadStatus").style.color = "var(--neg)";
    }
  };
  if (f.name.endsWith("json")) r.readAsText(f);
  else r.readAsArrayBuffer(f);
};

function init(data){
  rawData = data.map(d => ({
    ingreso: num(d["Imp.Neto a Comisionar"]),
    A√±o: normalizeText(d["A√±o inserci√≥n"]),
    Mes: normalizeMonth(d["Mes inserci√≥n"]),
    Revista: normalizeText(d["Publicaci√≥n"]),
    Product: normalizeText(d["Producto"]),
    Sector: cleanSector(d["Sector del anunciante"]),
    Comercial: normalizeText(d["Comercial"]),
    Area: normalizeText(d["√ÅREA"]),
    Anunciante: normalizeText(d["Anunciante"]),
    RevistaRaw: cleanRaw(d["Publicaci√≥n"]),
    ProductRaw: cleanRaw(d["Producto"]),
    ComercialRaw: cleanRaw(d["Comercial"]),
    AnuncianteRaw: cleanRaw(d["Anunciante"])
  })).filter(d => d.A√±o !== "");

  const years=[...new Set(rawData.map(d=>d.A√±o).filter(Boolean))].sort((a,b)=>b.localeCompare(a));
  const revistas=[...new Set(rawData.map(d=>d.Revista).filter(Boolean))].sort();
  const prods=[...new Set(rawData.map(d=>d.Product).filter(Boolean))].sort();
  const sects=[...new Set(rawData.map(d=>d.Sector).filter(Boolean))].sort();
  const comms=[...new Set(rawData.map(d=>d.Comercial).filter(Boolean))].sort();
  const areas=[...new Set(rawData.map(d=>d.Area).filter(Boolean))].sort();
  
  const advMap = new Map();
  rawData.forEach(d => {
    if(!d.Anunciante) return;
    advMap.set(d.Anunciante, (advMap.get(d.Anunciante) || 0) + d.ingreso);
  });
  
  const advs = Array.from(advMap.entries())
    .sort((a,b) => b[1] - a[1])
    .map(entry => entry[0]);

  fAnunciante.innerHTML = "<option>Todos</option>" + advs.map(v=>`<option value="${v}">${toTitleCase(v)}</option>`).join("");
  fRevista.innerHTML      = "<option>Todos</option>" + revistas.map(v=>`<option value="${v}">${toTitleCase(v)}</option>`).join("");
  fProduct.innerHTML   = "<option>Todos</option>" + prods.map(v=>`<option value="${v}">${toTitleCase(v)}</option>`).join("");
  fSector.innerHTML    = "<option>Todos</option>" + sects.map(v=>`<option value="${v}">${toTitleCase(v)}</option>`).join("");
  fYear.innerHTML      = "<option>Todos</option>" + years.map(v=>`<option>${v}</option>`).join("");
  fYear2.innerHTML     = "<option>Sin comparar</option>" + years.map(v=>`<option>${v}</option>`).join("");
  fComercial.innerHTML= "<option>Todos</option>" + comms.map(v=>`<option value="${v}">${toTitleCase(v)}</option>`).join("");
  fArea.innerHTML      = "<option>Todos</option>" + areas.map(v=>`<option value="${v}">${toTitleCase(v)}</option>`).join("");

  monthsBase.innerHTML = MONTHS.map(m=>`<label><input type="checkbox" value="${m}" onchange="render()"> ${m.slice(3)}</label>`).join("");
  monthsComp.innerHTML = MONTHS.map(m=>`<label><input type="checkbox" value="${m}" onchange="render()"> ${m.slice(3)}</label>`).join("");

  [fAnunciante,fRevista,fProduct,fSector,fYear,fYear2,fComercial,fArea].forEach(el=>el.onchange=render);

  advBlock.style.display   = "block";
  revistaBlock.style.display  = "block";
  filters.style.display    = "block";
  totalBlock.style.display = "block";
  statsBlock.style.display = "flex";
  advSummaryCard.style.display = "block";

  render();
}

function getSelectedMonths(id){
  const sel = Array.from(document.getElementById(id).querySelectorAll("input:checked")).map(c=>c.value);
  return sel.length ? sel : MONTHS;
}

function filterData(year,revista,product,sector,com,area,adv,months){
  return rawData.filter(d =>
    (year==="Todos" || d.A√±o===year) &&
    (revista==="Todos" || d.Revista===revista) &&
    (product==="Todos" || d.Product===product) &&
    (sector==="Todos" || d.Sector===sector) &&
    (com==="Todos" || d.Comercial===com) &&
    (area==="Todos" || d.Area===area) &&
    (adv==="Todos" || d.Anunciante===adv) &&
    months.includes(d.Mes)
  );
}

// NUEVA L√ìGICA DE NETEO POR ANUNCIANTE
function calcNetting(data) {
    const totalFact = data.reduce((acc, b) => acc + b.ingreso, 0);
    const groups = {};
    
    // Agrupamos por anunciante para netear individualmente
    data.forEach(d => {
        if (!groups[d.Anunciante]) groups[d.Anunciante] = [];
        groups[d.Anunciante].push(d.ingreso);
    });

    let finalLinesCount = 0;
    
    Object.values(groups).forEach(pool => {
        let sortedPool = pool.filter(v => v !== 0).sort((a, b) => Math.abs(a) - Math.abs(b));
        while (sortedPool.length > 0) {
            let current = sortedPool.shift();
            let counterpartIndex = sortedPool.findIndex(v => v === -current);
            if (counterpartIndex !== -1) {
                sortedPool.splice(counterpartIndex, 1);
            } else if (current > 0) {
                finalLinesCount++;
            }
        }
    });

    return {
        total: totalFact,
        lines: finalLinesCount,
        avg: finalLinesCount ? (totalFact / finalLinesCount) : 0
    };
}

function groupSumGeneric(data, keyFn, labelFn) {
  const map = new Map();
  for (const d of data) {
    const key = keyFn(d);
    if (!key) continue;
    const prev = map.get(key) || 0;
    map.set(key, prev + (Number(d.ingreso) || 0));
  }
  const arr = Array.from(map.entries()).map(([key, sum]) => ({ key, label: labelFn ? labelFn(key) : key, sum }));
  arr.sort((a, b) => String(a.label).localeCompare(String(b.label), 'es', {sensitivity:'base'}));
  return arr;
}

function groupSumMonths(data) {
  const map = new Map();
  for (const d of data) {
    const idx = Number(String(d.Mes).slice(0,2)) - 1;
    if (idx < 0) continue;
    map.set(idx, (map.get(idx) || 0) + (Number(d.ingreso) || 0));
  }
  return Array.from(map.entries()).sort((a,b) => a[0] - b[0]).map(([idx, sum]) => ({ label: MONTH_NAMES[idx], sum }));
}

function joinByLabel(baseArr, compArr){
  const compMap = new Map(compArr.map(o => [String(o.label), o.sum]));
  return baseArr.map(o => ({ label: o.label, base: o.sum, comp: compMap.get(String(o.label)) || 0 }));
}

function fillInlineList(ulId, items, options = {}){
  const { showPct=false } = options;
  const ul = document.getElementById(ulId);
  ul.innerHTML = "";
  if (!items || !items.length) { ul.innerHTML = "<li>‚Äî</li>"; return; }
  items.forEach(obj => {
    const li = document.createElement('li');
    li.appendChild(document.createTextNode(String(obj.label)));
    const amountVal = showPct ? obj.base : (obj.sum ?? obj.base);
    const amountSpan = document.createElement('span');
    amountSpan.className = 'amount';
    amountSpan.innerHTML = '<span class="sep">&nbsp;&nbsp;‚Äî&nbsp;&nbsp;</span>' + formatCurrency(amountVal);
    li.appendChild(amountSpan);
    if (showPct && Number(obj.comp) > 0) {
      const pct = Math.round(((Number(obj.base) / Number(obj.comp)) - 1) * 100);
      const pctSpan = document.createElement('span');
      pctSpan.className = 'pct ' + (pct < 0 ? 'neg' : 'pos');
      pctSpan.innerHTML = '<span class="sep">&nbsp;&nbsp;‚Äî&nbsp;&nbsp;</span>' + (pct>=0 ? '+' : '') + pct + '%';
      li.appendChild(pctSpan);
    }
    ul.appendChild(li);
  });
}

function renderAdvertiserSummary(dBase, dComp, advValue, y1, y2){
  document.getElementById('summaryYearBase').textContent = y1 || '‚Äî';
  document.getElementById('summaryYearComp').textContent = (y2 && y2!=="Sin comparar") ? y2 : 'Sin comparar';
  const isTodos=(advValue||"").toUpperCase()==="TODOS";
  if(isTodos){
    ['advMonthsBase','advMonthsComp','advRevistasBase','advRevistasComp','advProductsBase','advProductsComp','advSalesBase','advSalesComp']
      .forEach(id => { document.getElementById(id).innerHTML = '<li>‚Äî</li>'; });
    return;
  }
  const baseMonths = groupSumMonths(dBase);
  const baseRevistas = groupSumGeneric(dBase, d => (d.RevistaRaw || "").trim(), raw => (isURL(raw) ? raw.toLowerCase() : toTitleCase(raw)));
  const baseProds = groupSumGeneric(dBase, d => (d.ProductRaw || "").trim(), raw => toTitleCase(raw));
  const baseSales = groupSumGeneric(dBase, d => (d.ComercialRaw || "").trim(), raw => toTitleCase(raw));
  const compMonths = groupSumMonths(dComp);
  const compRevistas = groupSumGeneric(dComp, d => (d.RevistaRaw || "").trim(), raw => (isURL(raw) ? raw.toLowerCase() : toTitleCase(raw)));
  const compProds = groupSumGeneric(dComp, d => (d.ProductRaw || "").trim(), raw => toTitleCase(raw));
  const compSales = groupSumGeneric(dComp, d => (d.ComercialRaw || "").trim(), raw => toTitleCase(raw));

  fillInlineList('advMonthsBase', joinByLabel(baseMonths, compMonths), { showPct:true });
  fillInlineList('advRevistasBase', joinByLabel(baseRevistas, compRevistas), { showPct:true });
  fillInlineList('advProductsBase', joinByLabel(baseProds, compProds), { showPct:true });
  fillInlineList('advSalesBase', joinByLabel(baseSales, compSales), { showPct:true });
  fillInlineList('advMonthsComp', compMonths);
  fillInlineList('advRevistasComp', compRevistas);
  fillInlineList('advProductsComp', compProds);
  fillInlineList('advSalesComp', compSales);
}

function render(){
  const revista=fRevista.value, prod=fProduct.value, sec=fSector.value, y1=fYear.value, y2=fYear2.value, com=fComercial.value, area=fArea.value, adv=fAnunciante.value;
  const m1=getSelectedMonths("monthsBase"), m2=getSelectedMonths("monthsComp");
  const d1=filterData(y1,revista,prod,sec,com,area,adv,m1);
  const d2=y2!=="Sin comparar" ? filterData(y2,revista,prod,sec,com,area,adv,m2) : [];
  
  const s1 = calcNetting(d1);
  const s2 = calcNetting(d2);

  totalYear1.textContent = formatCurrency(s1.total);
  totalYear2.textContent = y2!=="Sin comparar" ? formatCurrency(s2.total) : "-";
  const dt=(y2!=="Sin comparar" && s2.total)?Math.round(((s1.total/s2.total)-1)*100):0;
  diffPercent.textContent = y2!=="Sin comparar" ? dt+"%" : "-";
  diffPercent.className = "value"+(dt<0?" negative":"");

  totalStatsBase.textContent=formatCurrency(s1.total);
  linesStatsBase.textContent=formatInteger(s1.lines);
  avgStatsBase.textContent=formatCurrency(s1.avg);

  if(y2!=="Sin comparar"){
    totalStatsComp.textContent=formatCurrency(s2.total);
    linesStatsComp.textContent=formatInteger(s2.lines);
    avgStatsComp.textContent=formatCurrency(s2.avg);
    const diffAvg=s2.avg>0?Math.round(((s1.avg/s2.avg)-1)*100):0;
    diffAvgStats.textContent=diffAvg+"%";
    diffAvgStats.className="value"+(diffAvg<0?" negative":"");
  } else {
    totalStatsComp.textContent="-"; linesStatsComp.textContent="0"; avgStatsComp.textContent="-"; diffAvgStats.textContent="0%";
  }
  renderAdvertiserSummary(d1, d2, adv, y1, y2);
}
</script>
</body>
</html>
