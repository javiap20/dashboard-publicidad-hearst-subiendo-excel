<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRINT - Detalle Marca y Producto por Anunciante y Marca</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --card:#111827;
  --text:#e5e7eb;
  
  /* COLORES PRINCIPALES (C√°mbialos aqu√≠ una sola vez) */
  --base: #38bdf8; /* Azul (A√±o Base) */
  --comp: #f59e0b; /* Naranja/Amarillo (A√±o Comparaci√≥n) */
  
  --neg:#f87171;
  --ok-green:#34d399;
  --totalBg:#1e40af;
  --siteBg:#fef3c7; 
  --productoBg:#dbeafe; 
  --sectorBg:#fbcfe8;
  --comercialBg:#d1fae5; 
  --areaBg:#fcd5ce; 
  --anuncianteBg:#e9d5ff;
  --print-color: #db2777;
  --summary-bg:#111827;
  --summary-border:#4b5563;
  --new-title-color: #a8ff53;
}

body {
  margin: 0;
  font-family: 'Inter', Arial, sans-serif;
  background: linear-gradient(180deg,#020617,#0f172a);
  color: var(--text);
  overflow-y: scroll;
}

.nav-menu {
  background: #111827;
  padding: 15px;
  text-align: center;
  border-bottom: 1px solid #374151;
  position: sticky;
  top: 0;
  z-index: 1000;
  height: 55px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.nav-menu a {
  color: #fff;
  margin: 0 10px;
  text-decoration: none;
  font-size: .9em;
  opacity: 0.8;
}
.nav-menu .active { opacity: 1; font-weight: bold; border-bottom: 2px solid var(--print-color); padding-bottom: 5px; }

h1 { text-align: center; font-size: 1.5rem; margin: 20px 0; }
.container{ max-width:1500px; margin:auto; padding:20px; }

.card{ background:rgba(17,24,39,.9); border-radius:14px; padding:18px; margin-bottom:20px; border: 1px solid #1f2937; }
.label-style { font-size: 0.95em; font-weight: bold; margin-bottom: 8px; display: block; }

.filters select, input[type=file]{
  background:#1f2933; color:var(--text); border:1px solid #374151;
  padding:8px 10px; border-radius:8px; width: 100%; box-sizing: border-box;
}

.advertiser-row {
  margin-bottom: 20px; padding: 20px; background: rgba(233, 213, 255, 0.1);
  border: 1px solid var(--anuncianteBg); border-radius: 14px;
}
.advertiser-row select {
  width: 100%; max-width: 600px; font-size: 1.1em; padding: 12px;
  background: var(--anuncianteBg) !important; color: #111 !important; font-weight: bold;
}

.filtersRow{ display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start; }
.filtersRow div { flex: 1; min-width: 180px; }

/* Etiquetas de filtros con variables din√°micas */
.label-base { color: var(--base) !important; }
.label-comp { color: var(--comp) !important; }

#fRevista{ background:var(--siteBg); color:#111; }
#fProduct{ background:var(--productoBg); color:#111; }
#fSector{ background:var(--sectorBg); color:#111; }
#fComercial{ background:var(--comercialBg); color:#111; }
#fArea{ background:var(--areaBg); color:#111; }

.checkboxGroup{ display:flex; flex-wrap:wrap; gap:10px; margin-top:5px; }
.checkboxGroup label{ font-size: 0.85em; color: #cbd5e1; display: flex; align-items: center; gap: 4px; cursor: pointer; }

.totalBlock{ background:var(--totalBg); padding:15px; border-radius:12px; margin-top:10px; }
.totalValues{ display:flex; justify-content:space-around; font-size:18px; align-items: center; }
.totalValues .value{ font-size:22px; font-weight:700; display: block; margin-top:5px; }
.var-badge { padding: 4px 10px; border-radius: 6px; font-weight: bold; background: rgba(0,0,0,0.4); }

.summaryCard{ border:1px dashed var(--summary-border); background:var(--summary-bg); border-radius:12px; padding:18px; }
.summaryMainTitle { 
    text-align: center; font-size: 1.3rem; font-weight: 800; color: var(--new-title-color); 
    margin-bottom: 25px; text-transform: uppercase; letter-spacing: 1.5px;
}
.summaryHeaderRow { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 10px; }
.summaryHeader { font-weight:800; color:#fff; border:1px solid #1f2937; border-radius:10px; padding:10px 12px; background:rgba(17,24,39,0.6); text-align: center; }

.brand-row-mirror { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
.mirror-col { background:rgba(2,6,23,0.35); border:1px solid rgba(75,85,99,0.3); border-radius:12px; padding:15px; text-align: center; }

.brand-title-box { border-bottom: 1px solid #374151; padding-bottom: 8px; margin-bottom: 12px; }

/* T√≠tulos de Marcas con variables din√°micas */
.brand-title { color: var(--base); font-weight: 800; font-size: 1.1em; display: block; margin-bottom: 4px; }
.brand-title.right { color: var(--comp); }

.brand-total-val { font-size: 1.15em; font-weight: bold; color: #fff; }

.product-list { list-style: none; padding: 0; margin: 0; }
.product-item { 
    font-size: 0.95em; color: #94a3b8; padding: 4px 0;
    display: flex; justify-content: center; gap: 8px; align-items: center;
    min-height: 1.5em;
}
.product-amount { color: #e5e7eb; font-weight: 600; }
.pos { color: var(--ok-green); }
.neg { color: var(--neg); }
.instruction-msg { text-align: center; padding: 60px; color: var(--base); font-size: 1.3em; grid-column: 1 / span 2; }
</style>
</head>

<body>

<nav class="nav-menu">
    <span style="color: var(--base); font-weight: bold; margin-right: 10px; opacity: 1;">DIGITAL:</span>
    <a href="digital-datos-graficos.html">Datos</a>
    <a href="digital-facturacion-desglosada.html">Desglose</a>
    <a href="digital-facturacion-por-anunciante.html">Anunciantes</a>
    <a href="digital-facturacion-por-anunciante-y-marca.html">Marcas</a>
    <a href="digital-totales-familas-productos.html">Productos</a>

    <span style="color: var(--print-color); font-weight: bold; margin-left: 20px; margin-right: 10px; border-left: 1px solid #4b5563; padding-left: 20px; opacity: 1;">PRINT:</span>
    <a href="print-datos-graficos.html">Datos</a>
    <a href="print-facturacion-desglosada.html">Desglose</a>
    <a href="print-facturacion-por-anunciante.html">Anunciantes</a>
    <a href="print-facturacion-por-anunciante-y-marca.html" class="active">Marcas</a>
    
    <a href="index.html" style="margin-left: 20px; border-left: 1px solid #4b5563; padding-left: 20px;">üè† Home</a>
</nav>

<h1>PRINT - Detalle Marca y Producto por Anunciante y Marca</h1>

<div class="container">
  <div class="card">
    <label class="label-style">Cargar datos (Excel):</label>
    <div class="file-input-wrapper">
    	<input type="file" id="fileInput" accept=".json,.xlsx">
    </div>
    <div id="loadStatus">Esperando archivo...</div>
  </div>

      <div class="card filters">
        <div class="filtersRow">
          <div>
            <label class="label-base">A√±o base</label>
            <select id="fYear"></select>
            <div class="checkboxGroup" id="monthsBase"></div>
          </div>
          <div>
            <label class="label-comp">A√±o comparaci√≥n</label>
            <select id="fYear2"></select>
            <div class="checkboxGroup" id="monthsComp"></div>
          </div>
        </div>
      </div>

  <div id="mainUI" style="display:none">
      <div class="advertiser-row">
          <label class="label-style" style="color:var(--anuncianteBg);">Seleccionar Anunciante Principal</label>
          <select id="fAnunciante"></select>
      </div>

      <div class="card filters">
        <div class="filtersRow">
          <div><label>Revista</label><select id="fRevista"></select></div>
          <div><label>Producto</label><select id="fProduct"></select></div>
          <div><label>Sector</label><select id="fSector"></select></div>
          <div><label>Comercial</label><select id="fComercial"></select></div>
          <div><label>√Årea</label><select id="fArea"></select></div>
        </div>
      </div>

      <div class="totalBlock card">
        <div class="totalValues">
          <div class="label-base">A√±o base<div id="totalYear1" class="value">0‚Ç¨</div></div>
          <div id="totalVariation" class="var-badge">‚Äî</div>
          <div class="label-comp">A√±o comparaci√≥n<div id="totalYear2" class="value">-</div></div>
        </div>
      </div>

      <div class="summaryCard" id="mirrorContainer"></div>
  </div>
</div>

<script>
const excelUrl = "PRODUCCION%20PRINT.xlsx";

window.addEventListener("DOMContentLoaded", () => {
  const statusEl = document.getElementById("loadStatus");
  if (statusEl) statusEl.innerText = "Cargando archivo PRODUCCION PRINT.xlsx‚Ä¶";

  fetch(excelUrl)
    .then(resp => {
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return resp.arrayBuffer();
    })
    .then(buf => {
      const wb = XLSX.read(buf, { type: "array" });
      const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" });
      init(json);
      if (statusEl) {
        statusEl.innerText = "‚úÖ Archivo cargado autom√°ticamente";
        statusEl.style.color = "var(--ok-green)";
      }
    })
    .catch(err => {
      console.error("Auto-carga fallida:", err);
      if (statusEl) {
        statusEl.innerText = "‚ö†Ô∏è No se pudo cargar autom√°ticamente. Selecciona el Excel manualmente.";
        statusEl.style.color = "var(--neg)";
      }
    });
});

const MONTHS = ["01 Enero","02 Febrero","03 Marzo","04 Abril","05 Mayo","06 Junio","07 Julio","08 Agosto","09 Septiembre","10 Octubre","11 Noviembre","12 Diciembre"];
let rawData = [];

function cleanSector(str) {
    if(!str) return "";
    return toTitleCase(str.replace(/[\*\d]/g, '').trim());
}

function toTitleCase(str) {
    if(!str) return "";
    return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
}

function num(v){
  if(v==null) return 0;
  if(typeof v === 'number') return v;
  return Number(String(v).replace(/\u00A0/g," ").replace(/‚Ç¨/g,"").replace(/\s/g,"").replace(/\./g,"").replace(/,/g,".")) || 0;
}

const formatCurrency = n => {
    return new Intl.NumberFormat('es-ES', { 
        style: 'decimal', 
        useGrouping: true, 
        minimumFractionDigits: 0, 
        maximumFractionDigits: 0 
    }).format(n) + " ‚Ç¨";
};

function getVarHtml(v1, v2) {
    if(!v2 || v2 === 0) return "";
    const p = ((v1 - v2) / v2) * 100;
    return `<span class="${p >= 0 ? 'pos' : 'neg'}">${p >= 0 ? '+' : ''}${p.toFixed(1)}%</span>`;
}

fileInput.onchange = e => {
  const f = e.target.files[0];
  const r = new FileReader();
  r.onload = ev => {
    const data = new Uint8Array(ev.target.result);
    const wb = XLSX.read(data, {type:"array"});
    init(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" }));
  };
  r.readAsArrayBuffer(f);
};

function init(data){
  rawData = data.map(d => ({
    ingreso: num(d["Imp.Neto a Comisionar"]),
    A√±o: String(d["A√±o inserci√≥n"] || "").trim(),
    Mes: MONTHS.find(m => m.startsWith(String(d["Mes inserci√≥n"]).trim().substring(0,2))) || "",
    Revista: toTitleCase(String(d["Publicaci√≥n"] || "").trim()), 
    Product: toTitleCase(String(d["Producto"] || "").trim()),
    Sector: cleanSector(String(d["Sector del anunciante"] || "")), 
    Comercial: toTitleCase(String(d["Comercial"] || "").trim()),
    Area: toTitleCase(String(d["√ÅREA"] || "").trim()), 
    Anunciante: String(d["Anunciante"] || "").trim().toUpperCase(),
    Marca: toTitleCase(String(d["Marca"] || "Sin Marca").trim())
  })).filter(d => d.A√±o !== "" && d.ingreso !== 0);

  const populate = (id, arr) => {
    document.getElementById(id).innerHTML = "<option>Todos</option>" + [...new Set(arr.filter(Boolean))].sort().map(v=>`<option>${v}</option>`).join("");
  };

  const advSums = {};
  rawData.forEach(d => advSums[d.Anunciante] = (advSums[d.Anunciante] || 0) + d.ingreso);
  const sortedAdvs = Object.keys(advSums).sort((a,b) => advSums[b] - advSums[a]);
  fAnunciante.innerHTML = "<option>Todos</option>" + sortedAdvs.map(v => `<option>${v}</option>`).join("");

  populate("fRevista", rawData.map(d=>d.Revista));
  populate("fProduct", rawData.map(d=>d.Product));
  populate("fSector", rawData.map(d=>d.Sector));
  populate("fComercial", rawData.map(d=>d.Comercial));
  populate("fArea", rawData.map(d=>d.Area));

  const years = [...new Set(rawData.map(d=>d.A√±o))].sort().reverse();
  fYear.innerHTML = "<option>Todos</option>" + years.map(y=>`<option>${y}</option>`).join("");
  fYear2.innerHTML = "<option>Sin comparar</option>" + years.map(y=>`<option>${y}</option>`).join("");

  document.getElementById("monthsBase").innerHTML = MONTHS.map(m=>`<label><input type="checkbox" value="${m}" onchange="render()"> ${m.slice(3)}</label>`).join("");
  document.getElementById("monthsComp").innerHTML = MONTHS.map(m=>`<label><input type="checkbox" value="${m}" onchange="render()"> ${m.slice(3)}</label>`).join("");

  [fAnunciante, fRevista, fProduct, fSector, fComercial, fArea, fYear, fYear2].forEach(el => el.onchange = render);
  document.getElementById("loadStatus").innerText = "‚úÖ Cargado";
  document.getElementById("mainUI").style.display = "block";
  render();
}

function getHierarchy(data) {
    const map = new Map();
    data.forEach(d => {
        if(d.ingreso === 0) return;
        if(!map.has(d.Marca)) map.set(d.Marca, { total: 0, products: {} });
        const m = map.get(d.Marca);
        m.total += d.ingreso;
        m.products[d.Product] = (m.products[d.Product] || 0) + d.ingreso;
    });
    return map;
}

function render() {
  const adv = fAnunciante.value.toUpperCase();
  const container = document.getElementById("mirrorContainer");
  if (adv === "TODOS") {
    container.innerHTML = `<div class="instruction-msg">‚ö†Ô∏è Selecciona un Anunciante.</div>`;
    return;
  }

  const rev = fRevista.value.toLowerCase(), prod = fProduct.value.toLowerCase(), 
        sec = fSector.value.toLowerCase(), com = fComercial.value.toLowerCase(), area = fArea.value.toLowerCase();
  const y1 = fYear.value, y2 = fYear2.value;
  const m1 = Array.from(document.getElementById("monthsBase").querySelectorAll("input:checked")).map(c=>c.value);
  const m2 = Array.from(document.getElementById("monthsComp").querySelectorAll("input:checked")).map(c=>c.value);

  const filter = (y, months) => rawData.filter(d => 
    d.Anunciante === adv && (y === "Todos" || d.A√±o === y) &&
    (rev === "todos" || d.Revista.toLowerCase() === rev) && (prod === "todos" || d.Product.toLowerCase() === prod) &&
    (sec === "todos" || d.Sector.toLowerCase() === sec) && (com === "todos" || d.Comercial.toLowerCase() === com) &&
    (area === "todos" || d.Area.toLowerCase() === area) && (months.length === 0 || months.includes(d.Mes))
  );

  const d1 = filter(y1, m1);
  const d2 = (y2 !== "Sin comparar") ? filter(y2, m2) : [];
  const h1 = getHierarchy(d1), h2 = getHierarchy(d2);
  const t1 = d1.reduce((s,i)=>s+i.ingreso,0), t2 = d2.reduce((s,i)=>s+i.ingreso,0);

  totalYear1.textContent = formatCurrency(t1);
  totalYear2.textContent = y2!=="Sin comparar" ? formatCurrency(t2) : "-";
  if(y2!=="Sin comparar" && t2 > 0) totalVariation.innerHTML = getVarHtml(t1, t2);

  let html = `<div class="summaryMainTitle">Desglose publicitario (productos) de las diferentes Marcas</div>`;
  html += `<div class="summaryHeaderRow"><div class="summaryHeader label-base">A√±o Base: ${y1}</div><div class="summaryHeader label-comp">A√±o Comparaci√≥n: ${y2}</div></div>`;

  const allBrands = [...new Set([...h1.keys(), ...h2.keys()])].sort((a,b) => (h1.get(b)?.total||0) - (h1.get(a)?.total||0));

  allBrands.forEach(brand => {
    const bM = h1.get(brand) || { total: 0, products: {} };
    const cM = h2.get(brand) || { total: 0, products: {} };
    
    const prodsBase = Object.keys(bM.products).sort((a,b) => bM.products[b] - bM.products[a]);
    const prodsCompExcl = Object.keys(cM.products).filter(p => !bM.products[p]);

    let listBase = prodsBase.map(p => {
        const val = bM.products[p];
        return `<li class="product-item"><span>${p}</span> <span class="product-amount">${formatCurrency(val)}</span> ${getVarHtml(val, cM.products[p]||0)}</li>`;
    }).join("");

    let listComp = prodsBase.map(p => {
        const val = cM.products[p];
        return `<li class="product-item">${val ? `<span>${p}</span> <span class="product-amount">${formatCurrency(val)}</span>` : ''}</li>`;
    }).join("");

    listComp += prodsCompExcl.map(p => {
        const val = cM.products[p];
        return `<li class="product-item"><span>${p}</span> <span class="product-amount">${formatCurrency(val)}</span></li>`;
    }).join("");

    html += `<div class="brand-row-mirror">
        <div class="mirror-col">
            <div class="brand-title-box">
                <span class="brand-title">${brand}</span>
                <span class="brand-total-val">${formatCurrency(bM.total)} ${getVarHtml(bM.total, cM.total)}</span>
            </div>
            <ul class="product-list">${listBase}</ul>
        </div>
        <div class="mirror-col">
            <div class="brand-title-box">
                <span class="brand-title right">${brand}</span>
                <span class="brand-total-val">${formatCurrency(cM.total)}</span>
            </div>
            <ul class="product-list">${listComp}</ul>
        </div>
    </div>`;
  });
  container.innerHTML = html;
}
</script>
</body>
</html>