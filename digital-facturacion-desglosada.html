<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIGITAL - Evoluci√≥n de los Ingresos</title>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --card:#111827;
  --text:#e5e7eb;
  /* CAMBIO DE COLORES AQU√ç */
  --base:#38bdf8;      
  --comp:#f59e0b;      
  
  --neg:#f87171;
  --diffColor:#6ee7b7;
  --ok-green: #34d399;
  --siteBg:#fef3c7; 
  --productoBg:#dbeafe; 
  --sectorBg:#fbcfe8;
  --comercialBg:#d1fae5; 
  --areaBg:#fcd5ce; 
  --familiaBg:#e9d5ff;
  --print-color: #db2777;
  --base-color: var(--base); /* Vinculado al nuevo color base */
}

body {
  margin: 0;
  font-family: 'Inter', Arial, sans-serif;
  background: linear-gradient(180deg,#020617,#0f172a);
  color: var(--text);
  overflow-y: scroll;
}

.nav-menu {
  background: #111827;
  padding: 15px;
  text-align: center;
  border-bottom: 1px solid #374151;
  position: sticky;
  top: 0;
  z-index: 1000;
  height: 55px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.nav-menu a {
  color: #fff;
  margin: 0 10px;
  text-decoration: none;
  font-size: .9em;
  opacity: 0.8;
}
.nav-menu .active { opacity: 1; font-weight: bold; border-bottom: 2px solid var(--base-color); padding-bottom: 5px; }

h1 { text-align: center; font-size: 1.5rem; margin: 20px 0; }
.container{ max-width:1550px; margin:auto; padding:20px; }

.card{
  background:rgba(17,24,39,.9);
  border-radius:14px;
  padding:18px;
  margin-bottom:20px;
  border: 1px solid #1f2937;
}

.filters select, input[type=file]{
  background:#1f2933; color:var(--text); border:1px solid #374151; padding:6px 8px; border-radius:8px; width: 100%; box-sizing: border-box; font-size: 0.85em;
}
.filters label{ font-weight:600; margin-right:6px; display:block; margin-top:8px; font-size: 0.85em; }
.filtersRow{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
.filtersRow div select{ width:170px; }

.checkboxGroup{ display:flex; flex-wrap:wrap; gap:8px; margin-top:5px; }
.checkboxGroup label{ font-size: 0.75em; font-weight:400; color: #cbd5e1; display: flex; align-items: center; gap: 4px; cursor: pointer; }

.statsBlock{ display:flex; justify-content:center; border-radius:12px; margin:20px 0; gap:10px; flex-wrap:wrap; }
.subBlock{ border-radius:12px; padding:20px; display:flex; align-items:center; justify-content:center; }

/* Los colores de estos bloques ahora se alimentan de las variables del root */
.statsBase{ flex:0 0 400px; background:var(--base); color: #111; }
.statsDiff{ flex:0 0 350px; background:var(--diffColor); color: #111; }
.statsComp{ flex:0 0 400px; background:var(--comp); color: #111; }

.statsValues{ display:flex; justify-content:center; font-size:14px; gap:20px; flex-wrap:wrap; }
.statsValues div{text-align:center;}
.statsValues .value{ font-size:18px; font-weight:700; display: block; margin-top: 5px;}
.value.negative { color: var(--neg) !important; }

#fSite{ background:var(--siteBg); color:#111; }
#fFamily{ background:var(--familiaBg); color:#111; }
#fProduct{ background:var(--productoBg); color:#111; }
#fSector{ background:var(--sectorBg); color:#111; }
#fComercial{ background:var(--comercialBg); color:#111; }
#fArea{ background:var(--areaBg); color:#111; }

.sites-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 20px;
    margin-top: 20px;
}
.mini-chart-card {
    background: rgba(17,24,39,0.8);
    border-radius: 12px;
    padding: 15px;
    border: 1px solid #374151;
}
.mini-chart-card h3 {
    font-size: 0.85rem;
    margin: 0 0 10px 0;
    text-align: center;
    color: var(--base);
    font-weight: normal;
}
.mini-chart { height: 220px; }
#chartArea { height: 400px; }
.title-filter-tag { color: #9ca3af; font-weight: normal; font-size: 0.9em; }
</style>
</head>

<body>

<nav class="nav-menu">
    <span style="color: var(--base-color); font-weight: bold; margin-right: 10px;">DIGITAL:</span>
    <a href="digital-datos-graficos.html">Datos</a>
    <a href="digital-facturacion-desglosada.html" class="active">Desglose</a>
    <a href="digital-facturacion-por-anunciante.html">Anunciantes</a>
    <a href="digital-facturacion-por-anunciante-y-marca.html">Marcas</a>
    <a href="digital-totales-familas-productos.html">Productos</a>

    <span style="color: var(--print-color); font-weight: bold; margin-left: 20px; margin-right: 10px; border-left: 1px solid #4b5563; padding-left: 20px;">PRINT:</span>
    <a href="print-datos-graficos.html">Datos</a>
    <a href="print-facturacion-desglosada.html">Desglose</a>
    <a href="print-facturacion-por-anunciante.html">Anunciantes</a>
    <a href="print-facturacion-por-anunciante-y-marca.html">Marcas</a>
    
    <a href="index.html" style="margin-left: 20px; border-left: 1px solid #4b5563; padding-left: 20px;">üè† Home</a>
</nav>

<h1>DIGITAL - Evoluci√≥n de los Ingresos</h1>

<div class="container">
  <div class="card">
    <label style="font-size: 0.9em; font-weight: bold;">Cargar datos (Excel):</label>
    <input type="file" id="fileInput" accept=".json,.xlsx">
    <div id="loadStatus" style="margin-top:5px; font-size:0.8em;">Cargando archivo autom√°ticamente...</div>
  </div>

<div id="filters" class="card filters" style="display:none">
    <div class="filtersRow">
      <div>
        <label style="color:var(--base)">A√±o base</label>
        <select id="fYear"></select>
        <div class="checkboxGroup" id="monthsBase"></div>
      </div>
      <div>
        <label style="color:var(--comp)">A√±o comparaci√≥n</label>
        <select id="fYear2"></select>
        <div class="checkboxGroup" id="monthsComp"></div>
      </div>
    </div>
  </div>

  <div id="siteBlock" class="card filters" style="display:none">
    <div class="filtersRow">
      <div><label>Site</label><select id="fSite"></select></div>
      <div><label>Familia</label><select id="fFamily"></select></div>
      <div><label>Producto</label><select id="fProduct"></select></div>
      <div><label>Sector</label><select id="fSector"></select></div>
      <div><label>Comercial</label><select id="fComercial"></select></div>
      <div><label>√Årea</label><select id="fArea"></select></div>
    </div>
  </div>

  <div id="statsBlock" class="card" style="display:none; background:none; border:none; padding:0;">
    <div class="statsBlock">
      <div class="subBlock statsBase">
        <div class="statsValues">
          <div>Fact. A√±o Base<div id="totalStatsBase" class="value">0‚Ç¨</div></div>
          <div>N¬∫ l√≠neas<div id="linesStatsBase" class="value">0</div></div>
          <div>Presupuesto medio<div id="avgStatsBase" class="value">0‚Ç¨</div></div>
        </div>
      </div>
      <div class="subBlock statsDiff">
        <div class="statsValues">
          <div>% Crec. Fact. Total<div id="diffTotalStats" class="value">0%</div></div>
          <div>% Crec. Presup. Medio<div id="diffAvgStats" class="value">0%</div></div>
        </div>
      </div>
      <div class="subBlock statsComp">
        <div class="statsValues">
          <div>Fact. A√±o Comparaci√≥n<div id="totalStatsComp" class="value">-</div></div>
          <div>N¬∫ l√≠neas<div id="linesStatsComp" class="value">0</div></div>
          <div>Presupuesto medio<div id="avgStatsComp" class="value">-</div></div>
        </div>
      </div>
    </div>
  </div>

  <div id="mainChartArea" class="card" style="display:none">
    <h2 id="mainChartTitle">Evoluci√≥n Mensual Acumulada</h2>
    <div id="chartArea"></div>
  </div>

  <h2 id="miniChartsTitle" style="display:none; text-align: center; margin: 30px 0 10px 0; font-size: 1.4rem;">Evoluci√≥n Mensual Acumulada por Site</h2>
  <div id="sitesGrid" class="sites-grid"></div>
</div>

<script>
const excelUrl = "PRODUCCION%20DIGITAL.xlsx";

window.addEventListener("DOMContentLoaded", () => {
  const statusEl = document.getElementById("loadStatus");
  if (statusEl) statusEl.innerText = "Cargando archivo PRODUCCION DIGITAL.xlsx‚Ä¶";

  fetch(excelUrl)
    .then(resp => {
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return resp.arrayBuffer();
    })
    .then(buf => {
      const workbook = XLSX.read(buf, { type: "array" });
      const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "" });
      init(data);
      if (statusEl) {
        statusEl.innerText = "‚úÖ Archivo cargado autom√°ticamente";
        statusEl.style.color = "var(--ok-green)";
      }
    })
    .catch(err => {
      if (statusEl) {
        statusEl.innerText = "‚ö†Ô∏è No se pudo cargar autom√°ticamente. Selecciona el Excel manualmente.";
        statusEl.style.color = "var(--neg)";
      }
    });
});

const MONTHS=["01 Enero","02 Febrero","03 Marzo","04 Abril","05 Mayo","06 Junio","07 Julio","08 Agosto","09 Septiembre","10 Octubre","11 Noviembre","12 Diciembre"];
let rawData=[];

function toTitleCase(str) { return str ? str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') : ""; }
function cleanSector(str) {
    if(!str) return "";
    let s = str.replace(/^[0-9* ]+/, ""); 
    return toTitleCase(s);
}
function num(v){
  if(v==null) return 0;
  if(typeof v === 'number') return v;
  let s = String(v).replace(/\u00A0/g," ").replace(/‚Ç¨/g,"").replace(/\s/g,"").replace(/\./g,"").replace(/,/g,".");
  return Number.isFinite(Number(s)) ? Number(s) : 0;
}
const currencyFormatter = new Intl.NumberFormat('es-ES', { useGrouping: true, minimumFractionDigits: 0, maximumFractionDigits: 0 });
function formatCurrency(n){ return currencyFormatter.format(Math.round(n || 0)) + '‚Ç¨'; }
const thousandFormatter = new Intl.NumberFormat('es-ES', { useGrouping: true, maximumFractionDigits: 0 });
function formatThousand(n){ return thousandFormatter.format(n || 0); }

fileInput.onchange = e => {
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ev => {
    const data = f.name.endsWith("json") ? JSON.parse(ev.target.result) : XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(ev.target.result), {type:"array"}).Sheets[XLSX.read(new Uint8Array(ev.target.result), {type:"array"}).SheetNames[0]], { defval: "" });
    init(data);
    document.getElementById("loadStatus").innerText = "‚úÖ Archivo cargado";
    document.getElementById("loadStatus").style.color = "var(--ok-green)";
  };
  f.name.endsWith("json") ? r.readAsText(f) : r.readAsArrayBuffer(f);
};

function init(data){
  rawData = data.map(d => ({
    ingreso: num(d["Imp.Neto a Comisionar"]),
    A√±o: String(d["A√±o inserci√≥n"] || "").trim(),
    Mes: MONTHS.find(m => m.startsWith(String(d["Mes inserci√≥n"]).trim().substring(0,2))) || "",
    Site: String(d["Publicaci√≥n"] || "").trim().toLowerCase(),
    Anunciante: String(d["Anunciante"] || "SIN ANUNCIANTE").trim().toUpperCase(),
    Family: toTitleCase(String(d["Familia"] || "").trim()),
    Product: toTitleCase(String(d["Producto"] || "").trim()),
    Sector: cleanSector(String(d["Sector"] || "")),
    Comercial: toTitleCase(String(d["Comercial"] || "").trim()),
    Area: toTitleCase(String(d["√ÅREAS"] || "").trim())
  })).filter(d => d.A√±o !== ""); 

  const populate = (id, arr, forceLower = false) => {
    document.getElementById(id).innerHTML = "<option>Todos</option>" + [...new Set(arr.filter(Boolean))].sort().map(v=> {
        let val = forceLower ? v.toLowerCase() : v;
        return `<option>${val}</option>`;
    }).join("");
  };

  populate("fSite", rawData.map(d=>d.Site), true);
  populate("fFamily", rawData.map(d=>d.Family));
  populate("fProduct", rawData.map(d=>d.Product));
  populate("fSector", rawData.map(d=>d.Sector));
  populate("fComercial", rawData.map(d=>d.Comercial));
  populate("fArea", rawData.map(d=>d.Area));
  
  const years = [...new Set(rawData.map(d=>d.A√±o))].sort().reverse();
  fYear.innerHTML = "<option>Todos</option>" + years.map(y=>`<option>${y}</option>`).join("");
  fYear2.innerHTML = "<option>Sin comparar</option>" + years.map(y=>`<option>${y}</option>`).join("");

  document.getElementById("monthsBase").innerHTML = MONTHS.map(m => `<label><input type="checkbox" value="${m}" onchange="render()"> ${m.slice(3)}</label>`).join("");
  document.getElementById("monthsComp").innerHTML = MONTHS.map(m => `<label><input type="checkbox" value="${m}" onchange="render()"> ${m.slice(3)}</label>`).join("");

  [fSite,fFamily,fProduct,fSector,fYear,fYear2,fComercial,fArea].forEach(e => e.onchange = render);
  siteBlock.style.display = "block"; filters.style.display = "block"; statsBlock.style.display= "block"; 
  mainChartArea.style.display = "block";
  document.getElementById("miniChartsTitle").style.display = "block";
  render();
}

function calcNetting(data) {
    const totalFact = data.reduce((acc, b) => acc + b.ingreso, 0);
    const groups = {};
    data.forEach(d => { if (!groups[d.Anunciante]) groups[d.Anunciante] = []; groups[d.Anunciante].push(d.ingreso); });
    let lines = 0;
    Object.values(groups).forEach(pool => {
        let filteredPool = pool.filter(v => v !== 0).sort((a, b) => Math.abs(a) - Math.abs(b));
        while (filteredPool.length > 0) {
            let cur = filteredPool.shift();
            let idx = filteredPool.findIndex(v => v === -cur);
            if (idx !== -1) filteredPool.splice(idx, 1);
            else if (cur > 0) lines++;
        }
    });
    return { total: totalFact, lines, avg: lines ? totalFact / lines : 0 };
}

function monthlySeries(data){
  const map = {}; MONTHS.forEach(m => map[m] = 0);
  data.forEach(d => { if(d.Mes) map[d.Mes] += d.ingreso; });
  return MONTHS.map(m => Math.round(map[m]));
}

function render(){
  const siteF = fSite.value, familyF = fFamily.value, prodF = fProduct.value, 
        sectF = fSector.value, comF = fComercial.value, areaF = fArea.value,
        y1 = fYear.value, y2 = fYear2.value;
        
  const m1 = Array.from(document.getElementById("monthsBase").querySelectorAll("input:checked")).map(c => c.value);
  const m2 = Array.from(document.getElementById("monthsComp").querySelectorAll("input:checked")).map(c => c.value);

  const dBase = rawData.filter(d => (y1 === "Todos" || d.A√±o === y1) && (siteF === "Todos" || d.Site === siteF.toLowerCase()) && (familyF === "Todos" || d.Family === familyF) && (prodF === "Todos" || d.Product === prodF) && (sectF === "Todos" || d.Sector === sectF) && (comF === "Todos" || d.Comercial === comF) && (areaF === "Todos" || d.Area === areaF) && (m1.length === 0 || m1.includes(d.Mes)));
  const dComp = y2 !== "Sin comparar" ? rawData.filter(d => d.A√±o === y2 && (siteF === "Todos" || d.Site === siteF.toLowerCase()) && (familyF === "Todos" || d.Family === familyF) && (prodF === "Todos" || d.Product === prodF) && (sectF === "Todos" || d.Sector === sectF) && (comF === "Todos" || d.Comercial === comF) && (areaF === "Todos" || d.Area === areaF) && (m2.length === 0 || m2.includes(d.Mes))) : [];

  const res1 = calcNetting(dBase);
  const res2 = calcNetting(dComp);

  totalStatsBase.textContent = formatCurrency(res1.total);
  linesStatsBase.textContent = formatThousand(res1.lines);
  avgStatsBase.textContent = formatCurrency(res1.avg);
  
  if(y2 !== "Sin comparar") {
    totalStatsComp.textContent = formatCurrency(res2.total);
    linesStatsComp.textContent = formatThousand(res2.lines);
    avgStatsComp.textContent = formatCurrency(res2.avg);
    const diffAvg = res2.avg ? Math.round(((res1.avg/res2.avg)-1)*100) : 0;
    const diffTotal = res2.total ? Math.round(((res1.total/res2.total)-1)*100) : 0;
    diffAvgStats.textContent = (diffAvg > 0 ? "+" : "") + diffAvg + "%";
    diffAvgStats.className = "value" + (diffAvg < 0 ? " negative" : "");
    diffTotalStats.textContent = (diffTotal > 0 ? "+" : "") + diffTotal + "%";
    diffTotalStats.className = "value" + (diffTotal < 0 ? " negative" : "");
  }

  // TRUCO PROFESIONAL: Lectura din√°mica de colores desde el CSS
  const style = getComputedStyle(document.documentElement);
  const colorBase = style.getPropertyValue('--base').trim();
  const colorComp = style.getPropertyValue('--comp').trim();

  const layoutBase = { 
    paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)", 
    font: { color: "#e5e7eb" }, margin: { t:30, l:50, r:20, b:40 },
    xaxis: { gridcolor: "#2d3748" }, yaxis: { gridcolor: "#2d3748", ticksuffix: "‚Ç¨" }
  };

  Plotly.newPlot("chartArea", [
    { x: MONTHS.map(m=>m.slice(3)), y: monthlySeries(dBase), type: 'scatter', fill: 'tozeroy', name: y1, line: {color: colorBase} },
    ...(y2 !== "Sin comparar" ? [{ x: MONTHS.map(m=>m.slice(3)), y: monthlySeries(dComp), type: 'scatter', fill: 'tozeroy', name: y2, line: {color: colorComp} }] : [])
  ], layoutBase);

  const sitesList = [...new Set(rawData.map(d => d.Site))].filter(s => s !== "www.micasarevista.com").sort();
  const grid = document.getElementById("sitesGrid");
  grid.innerHTML = "";

  sitesList.forEach((siteName, index) => {
    const sD1 = dBase.filter(d => d.Site === siteName);
    const sD2 = dComp.filter(d => d.Site === siteName);
    const container = document.createElement("div");
    container.className = "mini-chart-card";
    container.innerHTML = `<h3>${siteName.toLowerCase()}</h3><div id="site-chart-${index}" class="mini-chart"></div>`;
    grid.appendChild(container);
    Plotly.newPlot(`site-chart-${index}`, [
        { x: MONTHS.map(m=>m.slice(3,5)), y: monthlySeries(sD1), type: 'bar', name: y1, marker: {color: colorBase} },
        ...(y2 !== "Sin comparar" ? [{ x: MONTHS.map(m=>m.slice(3,5)), y: monthlySeries(sD2), type: 'bar', name: y2, marker: {color: colorComp} }] : [])
    ], { ...layoutBase, showlegend: false, margin: { t:10, l:35, r:10, b:25 }, yaxis: { gridcolor: "#2d3748", tickfont: {size: 9}, ticksuffix: "‚Ç¨" }, xaxis: { tickfont: {size: 9} } }, {displayModeBar: false});
  });
}
</script>
</body>
</html>